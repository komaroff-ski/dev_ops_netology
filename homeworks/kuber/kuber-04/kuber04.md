## Домашнее задание KUBER-04, С.Г. Комаров

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

#### Ответ:

Не до конца понял вводные данные. Можно рассмотреть два варианта действий:

1. В случае, если релиз подразумевает обновление структуры базы данных пориложения, которое приведет к неработоспособности старой версии приложения, то в ситуации ограниченных ресурсов необходимо сделать релиз с простоем и выбрать стратерию recreate с целью максимального уменьшения времении простоя приложения;

2.  В случае, если структура БД неизменна и старая версия приложения сможет работать параллельно с новой, то т.к. релиз мажорный и измениения серьезные, лучше применить стратегию Сanary, подняв минимально необходимый набор подов и подав на них ~10% трафика для тестирования работоспобосности обновления в боевых условиях. В случае успеха - плавно перевести трафик на новую версию.


### Задание 2. Обновить приложение

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
4. Откатиться после неудачного обновления.

#### Ответ:  

Ссылка на deployment nginx:  
Ссылка на deployment multitool:  

Для максимального сокращения времени обновления выставляем параметры:  

```    rollingUpdate:
       maxSurge: 4
       maxUnavailable: 4
```

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/2c35d678-dc91-47e4-9f7e-8ea7a7126ed0)

Делаем обновление 1.19 -> 1.20:

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/66ab258a-f060-45bb-a079-384e6cb049b2)

Делаем обновление 1.19 -> 1.28:

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/1ba26856-706c-46a6-a838-db1b0fc72e0c)

Откатываемся к предыдущему релизу:

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/7d70f58d-1b83-4d75-87b1-f15766df3caf)


## Дополнительные задания — со звёздочкой*

Задания дополнительные, необязательные к выполнению, они не повлияют на получение зачёта по домашнему заданию. **Но мы настоятельно рекомендуем вам выполнять все задания со звёздочкой.** Это поможет лучше разобраться в материале.   

### Задание 3*. Создать Canary deployment

1. Создать два deployment'а приложения nginx.
2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

#### Ответ:

Для реализации стратегии Canary развернул istio+kiali+prometheus, задеплоил две версии тестового приложения с сервисом, а так же Gateway, VirtualSerivce и DestinationRule для реализации корректной маршрутизации трафика с тестовой машины (mtool) к целевым нодам через ingress istio.

Ссылка на конфигурацию приложения:

Адрес ингреса (для теста использовал внутренний ip):

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/c9223b00-95f7-4e1d-ab2f-8d6a286705e9)

Генерируем трафик с пода mtool:  

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/df499972-fe60-477b-b1f1-56a28d099f20)

Начинаем постепенно переводить трафик с v1 на v2

100% трафика на v1:  

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/091cc3da-cd3b-4461-ba3a-4609acf6e480)

90% трафика на v1, 10% трафика на v2:  

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/b689d29e-bf8e-4223-993f-80fc38a0ab99)

50% трафика на v1, 50% трафика на v2:  

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/6ac57a75-7a60-46a7-90f0-3ea010749f3e)

100% трафика на v2:  

![image](https://github.com/komaroff-ski/dev_ops_netology/assets/93157702/f8f63722-9892-4d30-af18-1ce5a37799a9)
